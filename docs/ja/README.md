# AirStack ユーザーマニュアル

- [インストールガイド](#インストールガイド)
- [バーチャルホスト設定](#バーチャルホスト設定)
- [アンインストールガイド](#アンインストールガイド)
- [対応オペレーティングシステム](#対応オペレーティングシステム)
- [セキュリティの推奨事項](#セキュリティの推奨事項)
- [トラブルシューティング](#トラブルシューティング)

## インストールガイド

AirStack は、Ubuntu での Web アプリケーション用の包括的なスタック導入ソリューションを提供します。インストールスクリプト（`install.sh`）が、完全な本番環境のセットアップをガイドします。

### 必要条件

- Ubuntu 22.04 LTS または 24.04 LTS
- root または sudo 権限
- 最低 512MB の RAM
- 最低 10GB のディスク容量

### インストール手順

1. リポジトリをクローンしてスクリプトを実行可能にします：

```bash
git clone https://github.com/foxlau/airstack.git
cd airstack
chmod +x install.sh uninstall.sh vhost.sh
```

2. インストールスクリプトを実行します：

```bash
sudo ./install.sh
```

3. 対話式プロンプトに従います：

- **Web サーバースタック**：Nginx、Node.js、PM2（プロセスマネージャー）をインストール
- **データベース**：MySQL または PostgreSQL を選択
- **Redis**：オプションのインメモリデータストア
- **Fail2ban**：強く推奨されるサーバーセキュリティのための侵入防止システム

4. インストール後にシステムを再起動します：

```bash
sudo reboot
```

### コンポーネントの詳細

#### Web サーバースタック

- **Nginx**：高性能 HTTP サーバー
- **Node.js**：最新の LTS バージョン
- **PM2**：Node.js アプリケーション用プロセスマネージャー

#### データベースオプション

- **MySQL**：人気のあるリレーショナルデータベース

  - デフォルトの root パスワード：`rootair`（インストール後すぐに変更してください）
  - 設定ファイル：`/etc/mysql/`

- **PostgreSQL**：高度なオブジェクトリレーショナルデータベース
  - デフォルトのスーパーユーザーパスワード：`rootair`（インストール後すぐに変更してください）
  - 設定ファイル：`/etc/postgresql/`

#### 追加コンポーネント

- **Redis**：インメモリデータ構造ストア

  - 設定ファイル：`/etc/redis/`

- **Fail2ban**：侵入防止フレームワーク（強く推奨）
  - ブルートフォース攻撃からサーバーを保護
  - ログを監視し、不審な IP アドレスをブロック
  - 本番環境サーバーセキュリティに不可欠
  - 設定ファイル：`/etc/fail2ban/`

## バーチャルホスト設定

`vhost.sh`スクリプトは、Web アプリケーション用の Nginx バーチャルホストを設定します。

### 前提条件

- AirStack のインストールが完了していること
- サーバーの IP アドレスを指すドメイン名
- 特定のポートで実行されている Node.js アプリケーション

### 設定手順

1. バーチャルホスト設定スクリプトを実行します：

```bash
sudo ./vhost.sh
```

2. 対話式プロンプトに従います：

- **プライマリドメイン**：メインドメイン（例：example.com）
- **セカンダリドメイン**：オプションの追加ドメイン（例：www.example.com）
- **ドメインリダイレクト**：セカンダリからプライマリドメインへのリダイレクトオプション
- **Node.js ポート**：アプリケーションが実行されているポート（デフォルト：3000）
- **SSL オプション**：
  - HTTP のみ
  - Let's Encrypt 使用の HTTPS（自動 SSL 証明書）
  - カスタム SSL 証明書

### SSL 設定

#### Let's Encrypt SSL

Let's Encrypt SSL を選択した場合：

1. 証明書通知用のメールアドレスを提供します
2. スクリプトは以下を行います：
   - ドメイン所有権の確認
   - SSL 証明書の生成
   - 自動更新の設定（毎日午前 3 時に実行）

#### カスタム SSL 証明書

カスタム SSL を選択した場合：

1. SSL 証明書をアップロードします：`/etc/nginx/ssl/your-domain/`
2. 必要なファイル：
   - `fullchain.pem`：証明書チェーン全体
   - `privkey.pem`：秘密鍵ファイル

## アンインストールガイド

AirStack は、必要に応じてインストールされたコンポーネントを削除するスクリプトを提供します。

### アンインストール手順

1. アンインストールスクリプトを実行します：

```bash
sudo ./uninstall.sh
```

2. アンインストールしたいコンポーネントを選択します：

   - Node.js（JavaScript ランタイム環境）
   - Nginx（HTTP サーバー）
   - MySQL（リレーショナルデータベース）
   - PostgreSQL（オブジェクトリレーショナルデータベース）
   - Redis（インメモリデータストア）
   - Fail2ban（侵入防止システム）

3. 選択を確認します

### データバックアップ

**重要**：アンインストールする前に、重要なデータをバックアップしてください：

- MySQL データベース
- PostgreSQL データベース
- アプリケーションファイル
- 設定ファイル

## 対応オペレーティングシステム

AirStack は以下のシステムでテストおよびサポートされています：

- Ubuntu 22.04 LTS
- Ubuntu 24.04 LTS

## セキュリティの推奨事項

AirStack は基本的なセキュリティのために Fail2ban を含んでいますが、本番環境では追加のセキュリティ対策が推奨されます。

### ファイアウォールの設定

**重要**：AirStack は現在ファイアウォールを設定していません。セキュリティを強化するために、サーバーにファイアウォールを設定することを強く推奨します。

#### UFW（Uncomplicated Firewall）の使用

UFW は Ubuntu で推奨されているファイアウォールです。設定方法は以下の通りです：

1. UFW がまだインストールされていない場合はインストールします：

```bash
sudo apt-get install ufw
```

2. デフォルトポリシーを設定します：

```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
```

3. 必要なサービスを許可します：

```bash
# SSH をロックアウトされないように許可
sudo ufw allow ssh

# Web サーバーのための HTTP/HTTPS を許可
sudo ufw allow http
sudo ufw allow https

# オプション：必要に応じてアプリケーションの特定ポートを許可
sudo ufw allow 3000/tcp
```

4. ファイアウォールを有効にします：

```bash
sudo ufw enable
```

5. ステータスを確認します：

```bash
sudo ufw status verbose
```

### 追加のセキュリティ対策

- システムを定期的に更新します：

```bash
sudo apt-get update && sudo apt-get upgrade
```

- ログモニタリングの設定を検討する
- 定期的なセキュリティ監査を実施する
- すべてのサービスに強力でユニークなパスワードを使用する
- SSH のパスワード認証を無効にし、代わりに鍵ベースの認証を使用することを検討する

## トラブルシューティング

### 一般的な問題

#### インストール失敗

- `logs`ディレクトリのインストールログを確認
- システムが最小要件を満たしていることを確認
- インストール中のインターネット接続を確認

#### バーチャルホスト設定の問題

- ドメインがサーバーの IP アドレスを指していることを確認
- DNS 伝播が完了していることを確認
- `nginx -t`で Nginx 設定を確認

#### SSL 証明書の問題

- Let's Encrypt 失敗については、Certbot ログを確認
- ポート 80 がインターネットからアクセス可能であることを確認
- ドメイン所有権を確認

### ヘルプの取得

このドキュメントに記載されていない問題が発生した場合：

- GitHub リポジトリの issue を確認
- 問題の詳細情報を含む新しい issue を作成
- 関連するログとエラーメッセージを含める
