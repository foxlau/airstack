# AirStack ユーザーマニュアル

- [インストールガイド](#インストールガイド)
- [バーチャルホスト設定](#バーチャルホスト設定)
- [アンインストールガイド](#アンインストールガイド)
- [対応オペレーティングシステム](#対応オペレーティングシステム)
- [セキュリティに関する推奨事項](#セキュリティに関する推奨事項)
- [トラブルシューティング](#トラブルシューティング)

## インストールガイド

AirStack は、Ubuntu での Web アプリケーション用の包括的なスタック導入ソリューションを提供します。インストールスクリプト（`install.sh`）が、完全な本番環境のセットアップをガイドします。

### 必要条件

- Ubuntu 22.04 LTS または 24.04 LTS
- root または sudo 権限
- 最低 512MB の RAM
- 最低 10GB のディスク容量

### インストール手順

1. リポジトリをクローンしてスクリプトを実行可能にします：

```bash
git clone https://github.com/foxlau/airstack.git
cd airstack
chmod +x install.sh uninstall.sh vhost.sh
```

2. インストールスクリプトを実行します：

```bash
sudo ./install.sh
```

スクリプトはすべてのインストール手順を `logs/install_YYYYMMDD_HHMMSS.log` に記録します。

3. 対話式プロンプトに従います：

- **Web サーバースタック**：Nginx、Node.js、PM2（プロセスマネージャー）をインストール
- **データベース**：MySQL または PostgreSQL を選択
- **Redis**：オプションのインメモリデータストア
- **Fail2ban**：強く推奨されるサーバーセキュリティのための侵入防止システム

4. インストール後にシステムを再起動します：

```bash
sudo reboot
```

### コンポーネントの詳細

#### Web サーバースタック

- **Nginx**：高性能 HTTP サーバー
- **Node.js**：最新の LTS バージョン
- **PM2**：Node.js アプリケーション用プロセスマネージャー

#### データベースオプション

- **MySQL**：人気のあるリレーショナルデータベース

  - デフォルトの root パスワード：`rootair`（インストール後すぐに変更してください）
  - 設定ファイル：`/etc/mysql/`

- **PostgreSQL**：高度なオブジェクトリレーショナルデータベース
  - デフォルトのスーパーユーザーパスワード：`rootair`（インストール後すぐに変更してください）
  - 設定ファイル：`/etc/postgresql/`

#### 追加コンポーネント

- **Redis**：インメモリデータ構造ストア

  - 設定ファイル：`/etc/redis/`

- **Fail2ban**：侵入防止フレームワーク（強く推奨）
  - ブルートフォース攻撃からサーバーを保護
  - ログを監視し、不審な IP アドレスをブロック
  - 本番環境サーバーセキュリティに不可欠
  - 設定ファイル：`/etc/fail2ban/`

## バーチャルホスト設定

`vhost.sh`スクリプトは、Web アプリケーション用の Nginx バーチャルホストを設定します。

### 前提条件

- AirStack のインストールが完了していること
- サーバーの IP アドレスを指すドメイン名
- 特定のポートで実行されている Node.js アプリケーション

### 設定手順

1. バーチャルホスト設定スクリプトを実行します：

```bash
sudo ./vhost.sh
```

2. 対話式プロンプトに従います：

- **プライマリドメイン**：メインドメイン（例：example.com）
- **セカンダリドメイン**：オプションの追加ドメイン（例：www.example.com）
- **ドメインリダイレクト**：セカンダリからプライマリドメインへのリダイレクトオプション
- **Node.js ポート**：アプリケーションが実行されているポート（デフォルト：3000）
- **SSL オプション**：
  - HTTP のみ
  - Let's Encrypt 使用の HTTPS（自動 SSL 証明書）
  - カスタム SSL 証明書

### SSL 設定

#### Let's Encrypt SSL

Let's Encrypt SSL を選択した場合：

1. 証明書通知用のメールアドレスを提供します
2. スクリプトは以下を行います：
   - ドメイン所有権の確認
   - SSL 証明書の生成
   - 自動更新の設定（毎日午前 3 時に実行）

#### カスタム SSL 証明書

カスタム SSL を選択した場合：

1. SSL 証明書をアップロードします：`/etc/nginx/ssl/your-domain/`
2. 必要なファイル：
   - `fullchain.pem`：証明書チェーン全体
   - `privkey.pem`：秘密鍵ファイル

## アンインストールガイド

AirStack は、必要に応じてインストールされたコンポーネントを削除するスクリプトを提供します。

### アンインストール手順

1. アンインストールスクリプトを実行します：

```bash
sudo ./uninstall.sh
```

2. アンインストールしたいコンポーネントを選択します：

   - Node.js（JavaScript ランタイム環境）
   - Nginx（HTTP サーバー）
   - MySQL（リレーショナルデータベース）
   - PostgreSQL（オブジェクトリレーショナルデータベース）
   - Redis（インメモリデータストア）
   - Fail2ban（侵入防止システム）

3. 選択を確認します

### データバックアップ

**重要**：アンインストールする前に、重要なデータをバックアップしてください：

- MySQL データベース
- PostgreSQL データベース
- アプリケーションファイル
- 設定ファイル

## サーバーヘルスチェック

AirStack には、サーバーの健康状態を監視し、セキュリティ監査を実行するための包括的なスクリプト (`check.sh`) が含まれています。

### 実行方法

```bash
sudo ./check.sh
```

### 機能

このスクリプトは以下をチェックし、報告します：

- **システム情報**：OS、カーネル、稼働時間。
- **リソース使用状況**：CPU、メモリ、ディスク容量。
- **トッププロセス**：最も多くの CPU とメモリを消費しているプロセスをリストアップします。
- **サービスステータス**：Nginx、PM2、データベースなどの主要なサービスのステータスを確認します。
- **セキュリティ監査**：ユーザーアカウント、ファイル権限、ネットワーク露出などをカバーする詳細な監査。

### 監査レポート

詳細なセキュリティ監査レポートは、自動的に `logs/` ディレクトリに保存されます（例：`logs/server_check_YYYYMMDD_HHMMSS.txt`）。このレポートには、高リスク項目、警告、推奨事項を含む調査結果の概要が記載されています。

## 対応オペレーティングシステム

AirStack は以下のシステムでテストおよびサポートされています：

- Ubuntu 22.04 LTS
- Ubuntu 24.04 LTS

## セキュリティに関する推奨事項

サーバーのセキュリティを確保するため、AirStack には事前設定済みのファイアウォールと侵入防止システムが付属しています。

### ファイアウォール (UFW)

AirStack のインストールスクリプトは `UFW` (Uncomplicated Firewall) を自動的にインストールし、設定します。

**デフォルトルール**

- SSH (22)、HTTP (80)、HTTPS (443) ポートでの受信トラフィックを**許可**します。
- その他のすべての受信トラフィックを**拒否**します。
- すべての送信トラフィックを**許可**します。

**一般的なコマンド**

- 状態を確認する：
  ```bash
  sudo ufw status verbose
  ```
- 他のポートを開く（例：`3000/tcp`）：
  ```bash
  sudo ufw allow 3000/tcp
  ```

### 侵入防止 (Fail2ban)

AirStack は `Fail2ban` を自動的にインストール・設定し、ログを監視して不審な IP アドレスをブロックします。

**デフォルトルール (SSH 保護)**

- ある IP アドレスが 10 分以内に 5 回ログインに失敗した場合、その IP は 24 時間ブロックされます。

**一般的なコマンド**

- ブロック状態を確認する：
  ```bash
  sudo fail2ban-client status sshd
  ```
- 手動で IP のブロックを解除する：
  ```bash
  sudo fail2ban-client set sshd unbanip <IP_ADDRESS>
  ```

### 追加のセキュリティ対策

- 定期的にシステムを更新します：

```bash
sudo apt-get update && sudo apt-get upgrade
```

- ログモニタリングの設定を検討する
- 定期的なセキュリティ監査を実施する
- すべてのサービスに強力でユニークなパスワードを使用する
- SSH のパスワード認証を無効にし、代わりに鍵ベースの認証を使用することを検討する

## トラブルシューティング

### 一般的な問題

#### インストール失敗

- `logs`ディレクトリのインストールログを確認
- システムが最小要件を満たしていることを確認
- インストール中のインターネット接続を確認

#### バーチャルホスト設定の問題

- ドメインがサーバーの IP アドレスを指していることを確認
- DNS 伝播が完了していることを確認
- `nginx -t`で Nginx 設定を確認

#### SSL 証明書の問題

- Let's Encrypt 失敗については、Certbot ログを確認
- ポート 80 がインターネットからアクセス可能であることを確認
- ドメイン所有権を確認

### ヘルプの取得

このドキュメントに記載されていない問題が発生した場合：

- GitHub リポジトリの issue を確認
- 問題の詳細情報を含む新しい issue を作成
- 関連するログとエラーメッセージを含める
